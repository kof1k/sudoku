# Архітектура проекту "Судоку"

## Зміст

1. [Загальний огляд](#загальний-огляд)
2. [Архітектурний шаблон MVC](#архітектурний-шаблон-mvc)
3. [Структура серверної частини](#структура-серверної-частини)
4. [Структура клієнтської частини](#структура-клієнтської-частини)
5. [Потоки даних](#потоки-даних)
6. [Компоненти системи](#компоненти-системи)
7. [Безпека](#безпека)

---

## Загальний огляд

Проект побудований на основі **трирівневої архітектури**:

```
┌─────────────────────────────────────────────────────────────┐
│                   РІВЕНЬ ПРЕДСТАВЛЕННЯ                      │
│              (Presentation Layer / Frontend)                │
│                                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  HTML5   │  │   CSS3   │  │ sudoku.js│  │ chat.js  │    │
│  │ Шаблони  │  │  Стилі   │  │Логіка гри│  │  Чат     │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────────┬───────────────────────────────┘
                              │ HTTP/HTTPS (JSON, HTML)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    РІВЕНЬ БІЗНЕС-ЛОГІКИ                     │
│               (Business Logic Layer / Backend)              │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                  Django Framework                     │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────┐  │  │
│  │  │  urls.py   │  │  views.py  │  │ SudokuGenerator│  │  │
│  │  │ Маршрути   │  │ Контролери │  │ Бізнес-логіка  │  │  │
│  │  └────────────┘  └────────────┘  └────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────┬───────────────────────────────┘
                              │ SQL через Django ORM
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     РІВЕНЬ ДАНИХ                            │
│                (Data Layer / Database)                      │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   PostgreSQL                          │  │
│  │  ┌─────────────┐ ┌──────────────┐ ┌───────────────┐  │  │
│  │  │ auth_user   │ │ gameresult   │ │ chatmessage   │  │  │
│  │  └─────────────┘ └──────────────┘ └───────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Архітектурний шаблон MVC

Django використовує шаблон **MVT** (Model-View-Template), який є варіацією класичного MVC:

### Порівняння MVC та MVT

| Класичний MVC | Django MVT | Призначення |
|---------------|------------|-------------|
| Model | Model | Робота з даними (БД) |
| View | Template | Відображення даних |
| Controller | View | Бізнес-логіка, обробка запитів |

### Структура MVT в проекті

```
┌─────────────────────────────────────────────────────────────────┐
│                         HTTP ЗАПИТ                              │
│                    (від браузера користувача)                   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       URL DISPATCHER                            │
│                         (urls.py)                               │
│                                                                 │
│  Визначає, який View обробить запит на основі URL:             │
│  - /game/ → game_view                                          │
│  - /chat/ → chat_view                                          │
│  - /leaderboard/ → leaderboard_view                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                           VIEW                                  │
│                        (views.py)                               │
│                                                                 │
│  Обробляє запит та формує відповідь:                           │
│  1. Валідація вхідних даних                                    │
│  2. Взаємодія з Model                                          │
│  3. Виклик бізнес-логіки                                       │
│  4. Вибір Template або формування JSON                         │
└────────┬────────────────────────────────────────┬───────────────┘
         │                                        │
         ▼                                        ▼
┌─────────────────────────┐        ┌─────────────────────────────┐
│         MODEL           │        │         TEMPLATE            │
│       (models.py)       │        │  (templates/*.html)         │
│                         │        │                             │
│  Визначає структуру     │        │  Генерує HTML на основі     │
│  даних та взаємодіє     │        │  контексту від View         │
│  з базою даних          │        │                             │
└────────┬────────────────┘        └──────────────┬──────────────┘
         │                                        │
         ▼                                        │
┌─────────────────────────┐                       │
│       DATABASE          │                       │
│     (PostgreSQL)        │                       │
└─────────────────────────┘                       │
                                                  ▼
                              ┌─────────────────────────────────────┐
                              │            HTTP ВІДПОВІДЬ           │
                              │     (HTML сторінка або JSON)        │
                              └─────────────────────────────────────┘
```

---

## Структура серверної частини

### Файлова організація Backend

```
django_project/              # Конфігурація Django проекту
├── __init__.py              # Ініціалізація пакету
├── settings.py              # Налаштування проекту
│   ├── DEBUG                # Режим розробки
│   ├── DATABASES            # Підключення до БД
│   ├── INSTALLED_APPS       # Встановлені додатки
│   ├── TEMPLATES            # Налаштування шаблонів
│   └── STATIC_URL           # Шлях до статики
├── urls.py                  # Головний роутер
├── wsgi.py                  # WSGI точка входу
└── asgi.py                  # ASGI точка входу

sudoku/                      # Основний додаток
├── __init__.py
├── apps.py                  # Конфігурація додатку
├── models.py                # Моделі даних
│   ├── GameResult           # Результати ігор
│   ├── ChatMessage          # Повідомлення чату
│   ├── EmailVerification    # Верифікація email
│   └── SudokuGenerator      # Генератор головоломок
├── views.py                 # Обробники запитів
│   ├── Аутентифікація       # register, login, logout
│   ├── Гра                  # game, submit, hint
│   └── Соціальне            # chat, leaderboard
├── urls.py                  # Маршрути додатку
├── admin.py                 # Django Admin
└── migrations/              # Міграції БД
```

### Опис компонентів Backend

#### 1. settings.py — Конфігурація проекту

```python
# Основні налаштування
DEBUG = True/False               # Режим розробки
SECRET_KEY = '...'               # Секретний ключ
ALLOWED_HOSTS = ['domain.com']   # Дозволені хости

# База даних
DATABASES = {
    'default': dj_database_url.parse(DATABASE_URL)
}

# Додатки
INSTALLED_APPS = [
    'django.contrib.admin',      # Адмін панель
    'django.contrib.auth',       # Авторизація
    'django.contrib.sessions',   # Сесії
    'sudoku',                    # Наш додаток
]

# Шаблони
TEMPLATES = [
    {
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
    }
]

# Статичні файли
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
```

#### 2. models.py — Моделі даних

```python
# GameResult — зберігає результати ігор
class GameResult(models.Model):
    user = models.ForeignKey(User)       # Зв'язок з користувачем
    difficulty = models.CharField()      # easy/medium/hard
    time_seconds = models.IntegerField() # Час в секундах
    hints_used = models.IntegerField()   # 0-3 підказки
    completed = models.BooleanField()    # True/False
    created_at = models.DateTimeField()  # Автоматична дата

# ChatMessage — зберігає повідомлення
class ChatMessage(models.Model):
    user = models.ForeignKey(User)       # Автор
    message = models.TextField()         # Текст
    created_at = models.DateTimeField()  # Час

# SudokuGenerator — генератор головоломок (не модель БД)
class SudokuGenerator:
    @staticmethod
    def generate_full_board()            # Генерація дошки
    @staticmethod
    def create_puzzle(difficulty)        # Створення пазлу
    @staticmethod
    def check_solution(puzzle, answer)   # Перевірка
```

#### 3. views.py — Обробники запитів

```python
# Типи Views у проекті:

# 1. Функціональний View (Function-Based View)
def home(request):
    return render(request, 'home.html')

# 2. View з авторизацією
@login_required
def game_view(request):
    difficulty = request.GET.get('difficulty', 'medium')
    puzzle, solution = SudokuGenerator.create_puzzle(difficulty)
    request.session['solution'] = solution
    return render(request, 'game.html', {'puzzle': puzzle})

# 3. API View (повертає JSON)
@login_required
@require_POST
def submit_game(request):
    data = json.loads(request.body)
    # Обробка...
    return JsonResponse({'status': 'success'})
```

---

## Структура клієнтської частини

### Файлова організація Frontend

```
templates/                   # HTML шаблони
├── base.html                # Базовий шаблон (layout)
│   ├── <head>               # Meta, CSS, Title
│   ├── <nav>                # Навігація
│   ├── {% block content %}  # Контент сторінки
│   └── <script>             # JavaScript
├── home.html                # Головна сторінка
├── game.html                # Ігрова дошка
├── leaderboard.html         # Таблиця лідерів
├── chat.html                # Чат
└── registration/            # Авторизація
    ├── login.html
    └── register.html

static/                      # Статичні файли
├── css/
│   └── style.css            # Всі стилі (824 рядки)
│       ├── CSS Variables    # Кольори, розміри
│       ├── Base Styles      # Базові стилі
│       ├── Navigation       # Меню
│       ├── Game Board       # Дошка судоку
│       ├── Number Pad       # Панель чисел
│       ├── Modals           # Модальні вікна
│       └── Responsive       # Адаптивність
└── js/
    ├── main.js              # Навігація (39 рядків)
    ├── sudoku.js            # Логіка гри (394 рядки)
    └── chat.js              # Чат (89 рядків)
```

### Опис JavaScript модулів

#### 1. sudoku.js — Ігрова логіка

```javascript
// Глобальні змінні
let puzzle = [];              // Початкова дошка
let solution = [];            // Розв'язок
let currentBoard = [];        // Поточний стан
let selectedCell = null;      // Вибрана клітинка
let mistakes = 0;             // Кількість помилок
let hints = 0;                // Використано підказок
let notesMode = false;        // Режим нотаток
let cellNotes = {};           // Нотатки для клітинок
let timerInterval = null;     // Інтервал таймера
let seconds = 0;              // Секунди

// Основні функції
function buildBoard()         // Побудова DOM
function handleCellClick(i,j) // Обробка кліку
function enterNumber(num)     // Введення числа
function updateHighlighting() // Підсвічування
function checkWin()           // Перевірка перемоги
function showWin()            // Модальне вікно перемоги
function showGameOver()       // Модальне вікно програшу
function toggleNotesMode()    // Перемикання нотаток
function getHint()            // Отримання підказки
function startTimer()         // Запуск таймера
function updateTimer()        // Оновлення таймера
function navigateCell(dir)    // Навігація стрілками
```

#### 2. chat.js — Функціонал чату

```javascript
// Змінні
let lastMessageId = 0;        // ID останнього повідомлення

// Функції
function loadMessages()       // Завантаження повідомлень
function pollMessages()       // Опитування сервера (кожні 3с)
function addMessage(msg)      // Додавання повідомлення в DOM
function sendMessage()        // Відправка повідомлення
function escapeHtml(text)     // Екранування HTML (безпека)
```

#### 3. main.js — Загальний функціонал

```javascript
// Функції
function toggleMenu()         // Відкриття/закриття меню
document.addEventListener()   // Ініціалізація
```

---

## Потоки даних

### 1. Потік гри (Game Flow)

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ПОЧАТОК ГРИ                                    │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. Користувач вибирає складність (Easy/Medium/Hard)               │
│     → GET /game/?difficulty=medium                                  │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. Сервер генерує головоломку                                     │
│     → SudokuGenerator.create_puzzle('medium')                       │
│     → session['puzzle'] = puzzle                                    │
│     → session['solution'] = solution                                │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. Клієнт отримує HTML з дошкою                                   │
│     → game.html з {{ puzzle|safe }}                                 │
│     → sudoku.js викликає buildBoard()                               │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. Користувач грає                                                │
│     → Клік на клітинку → handleCellClick()                         │
│     → Введення числа → enterNumber()                                │
│     → Перевірка помилок                                            │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. Перемога або програш                                           │
│     Перемога: checkWin() → showWin() → POST /game/submit/          │
│     Програш: mistakes >= 3 → showGameOver()                        │
└───────────────────────────┬─────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. Збереження результату                                          │
│     → GameResult.objects.create(user, difficulty, time, hints)     │
│     → Редірект на leaderboard                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. Потік авторизації (Auth Flow)

```
┌────────────────────────────────────────────────────────────┐
│                     РЕЄСТРАЦІЯ                             │
├────────────────────────────────────────────────────────────┤
│  1. GET /register/                                         │
│     → Відображення форми                                   │
│                                                            │
│  2. POST /register/                                        │
│     → Валідація (username, password1, password2)           │
│     → User.objects.create_user()                           │
│     → Redirect /login/                                     │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                        ВХІД                                │
├────────────────────────────────────────────────────────────┤
│  1. GET /login/                                            │
│     → Відображення форми                                   │
│                                                            │
│  2. POST /login/                                           │
│     → authenticate(username, password)                      │
│     → login(request, user)                                 │
│     → Створення сесії                                      │
│     → Redirect /                                           │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                        ВИХІД                               │
├────────────────────────────────────────────────────────────┤
│  GET /logout/                                              │
│  → logout(request)                                         │
│  → Видалення сесії                                         │
│  → Redirect /                                              │
└────────────────────────────────────────────────────────────┘
```

### 3. Потік чату (Chat Flow)

```
┌─────────────────────────────────────────────────────────────────────┐
│                       ЧАТОВА СИСТЕМА                                │
└───────────────────────────┬─────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────────┐
│ Завантаження  │   │   Відправка   │   │    Оновлення     │
│  сторінки     │   │  повідомлення │   │   (polling)      │
└───────┬───────┘   └───────┬───────┘   └─────────┬─────────┘
        │                   │                     │
        ▼                   ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────────┐
│ GET /chat/    │   │POST /chat/send│   │GET /chat/messages │
│               │   │ {message: ""}  │   │ ?last_id=123      │
│ Останні 50    │   │               │   │                   │
│ повідомлень   │   │ ChatMessage   │   │ Нові повідомлення │
└───────────────┘   │ .create()     │   │ з id > last_id    │
                    └───────────────┘   └───────────────────┘
                                                │
                                                ▼
                                        ┌───────────────────┐
                                        │ setInterval(      │
                                        │   pollMessages,   │
                                        │   3000            │
                                        │ )                 │
                                        └───────────────────┘
```

---

## Компоненти системи

### Діаграма компонентів

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           БРАУЗЕР                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      HTML СТОРІНКИ                               │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐    │   │
│  │  │   home    │ │   game    │ │   chat    │ │  leaderboard  │    │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────────┘    │   │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      JAVASCRIPT                                  │   │
│  │  ┌───────────────────┐  ┌───────────────────────────────────┐   │   │
│  │  │     sudoku.js     │  │           chat.js                 │   │   │
│  │  │ - Ігрова логіка   │  │ - Polling повідомлень             │   │   │
│  │  │ - Валідація       │  │ - Відправка/отримання             │   │   │
│  │  │ - UI взаємодія    │  │ - DOM маніпуляції                 │   │   │
│  │  └───────────────────┘  └───────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        CSS                                       │   │
│  │  ┌───────────────────────────────────────────────────────────┐  │   │
│  │  │                     style.css                              │  │   │
│  │  │ - CSS Variables (кольори, розміри)                        │  │   │
│  │  │ - Flexbox/Grid layouts                                    │  │   │
│  │  │ - Анімації та переходи                                    │  │   │
│  │  │ - Responsive дизайн                                       │  │   │
│  │  └───────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/HTTPS
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DJANGO СЕРВЕР                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       URL ROUTING                                │   │
│  │  ┌────────────────────────────────────────────────────────────┐ │   │
│  │  │  django_project/urls.py → sudoku/urls.py                   │ │   │
│  │  └────────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          VIEWS                                   │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │   │
│  │  │    Auth    │ │    Game    │ │    Chat    │ │ Leaderboard│   │   │
│  │  │ register   │ │ game_view  │ │ chat_view  │ │ leaderboard│   │   │
│  │  │ login      │ │ submit     │ │ send_msg   │ │ _view      │   │   │
│  │  │ logout     │ │ get_hint   │ │ get_msgs   │ │            │   │   │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         MODELS                                   │   │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────────────────────┐  │   │
│  │  │ GameResult │ │ChatMessage │ │     SudokuGenerator        │  │   │
│  │  │            │ │            │ │ - generate_full_board()    │  │   │
│  │  │            │ │            │ │ - create_puzzle()          │  │   │
│  │  │            │ │            │ │ - check_solution()         │  │   │
│  │  └────────────┘ └────────────┘ └────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       DJANGO ORM                                 │   │
│  │  Автоматичне перетворення Python об'єктів у SQL запити          │   │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ SQL
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          POSTGRESQL                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  auth_user       │  sudoku_gameresult  │  sudoku_chatmessage    │   │
│  │  ───────────     │  ─────────────────  │  ───────────────────   │   │
│  │  id              │  id                 │  id                    │   │
│  │  username        │  user_id (FK)       │  user_id (FK)          │   │
│  │  password        │  difficulty         │  message               │   │
│  │  email           │  time_seconds       │  created_at            │   │
│  │  ...             │  hints_used         │                        │   │
│  │                  │  completed          │                        │   │
│  │                  │  created_at         │                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Безпека

### Реалізовані механізми безпеки

#### 1. CSRF Protection (Cross-Site Request Forgery)

```html
<!-- В кожній формі -->
<form method="POST">
    {% csrf_token %}
    <!-- поля форми -->
</form>
```

```javascript
// В JavaScript запитах
fetch('/api/endpoint/', {
    method: 'POST',
    headers: {
        'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
});
```

#### 2. Авторизація (@login_required)

```python
from django.contrib.auth.decorators import login_required

@login_required
def game_view(request):
    # Тільки для авторизованих користувачів
    pass
```

#### 3. Валідація HTTP методів

```python
from django.views.decorators.http import require_POST

@require_POST
def submit_game(request):
    # Тільки POST запити
    pass
```

#### 4. XSS Protection (Cross-Site Scripting)

```javascript
// В chat.js
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Використання
addMessage({
    username: escapeHtml(msg.username),
    message: escapeHtml(msg.message)
});
```

#### 5. Session-based аутентифікація

```python
# Django автоматично управляє сесіями
# Зберігання в БД або файлах
SESSION_ENGINE = 'django.contrib.sessions.backends.db'
```

#### 6. Захист паролів

```python
# Django автоматично хешує паролі
# Використовує PBKDF2 з SHA256
from django.contrib.auth.hashers import make_password

password_hash = make_password('user_password')
# Результат: pbkdf2_sha256$260000$salt$hash
```

### Таблиця безпеки

| Загроза | Захист | Реалізація |
|---------|--------|------------|
| CSRF | CSRF Token | `{% csrf_token %}` в формах |
| XSS | Escaping | `escapeHtml()` в JavaScript |
| SQL Injection | ORM | Django ORM замість raw SQL |
| Brute Force | Session limits | Django sessions |
| Unauthorized Access | @login_required | Декоратори views |

---

## Висновок

Архітектура проекту "Судоку" базується на перевірених принципах:

1. **Розділення відповідальності** — кожен компонент має чітку роль
2. **Модульність** — легко розширювати та модифікувати
3. **Безпека** — захист від основних веб-уразливостей
4. **Масштабованість** — можливість горизонтального масштабування

Така архітектура забезпечує надійну та продуктивну роботу веб-додатку.
